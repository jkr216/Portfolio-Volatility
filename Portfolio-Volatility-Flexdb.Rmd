---
title: "Portfolio Volatility App"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
---


```{r setup, include=FALSE}
library(flexdashboard)
#library(quantmod)
library(tidyverse)
library(PerformanceAnalytics)
library(tidyquant)
library(DT)
library(data.table)
library(highcharter)

source("function-folder/helpers.r")
```

```{r, eval = FALSE}
# Shiny app that lets user: 
# build a portfolio by choosing assets and weights; 
# choose a time period
# import and calculate prices and returns on some period like monthly
# calculate portfolio standard devation
# calculate contribution of each component to sd over that time period
# chart the contribution
# Advanced applications

```

Page 1
===========================================

Sidebar {.sidebar}
-----------------------------------------------------------------------

```{r}

helpText("Choose assets and weights.")

fluidRow(
  column(7,
  textInput("stock1", "Stock 1", "GOOG")),
  column(5,
  numericInput("w1", "Portf. %", 25, min = 1, max = 100))
)  

fluidRow(
  column(7,
  textInput("stock2", "Stock 2", "FB")),
  column(5,
  numericInput("w2", "Portf. %", 25, min = 1, max = 100))
)

fluidRow(
  column(7,
  textInput("stock3", "Stock 3", "AMZN")),
  column(5,
  numericInput("w3", "Portf. %", 50, min = 1, max = 100))
)

fluidRow(
  column(7,
  dateInput("start_date", "Start Date", value = "2017-01-01")),
  column(5,
  numericInput("window", "Window", 10, min = 5, max = 50, step = 5))
)

```

```{r}
returns_df <- reactive({
  componentReturns_df(input$stock1, input$stock2, input$stock3, input$start_date)
})

portfolio_vol_components <- reactive({
  returns_df <- as.data.frame(returns_df()) %>% mutate(date = ymd(date))
  weights <- c(input$w1, input$w2, input$w3)
  
  port_components <- map_df(1:(nrow(returns_df)-input$window), my_interval_sd,
                            returns_df = returns_df, weights = weights, window = input$window) %>%
    mutate_all(funs(round(., 3))) %>% 
    mutate(date = ymd(date)) %>%
    select(date, everything()) %>%
    as_xts(date_col = date)
  # an xts comes out of this
})
```



Column
-----------------------------------------------------------------------

### Chart B

```{r}

renderHighchart({

  # The output of this is an xts
  portfolio_vol_components <- portfolio_vol_components()
  
  highchart(type = "stock") %>% 
   hc_title(text = "Volatility Contribution") %>%
   hc_add_series(portfolio_vol_components[, 1], name = input$stock1) %>%
   hc_add_series(portfolio_vol_components[, 2], name = input$stock2) %>%
   hc_add_series(portfolio_vol_components[, 3], name = input$stock3) %>% 
    # I don't like the look of the navigator/scrollbar, but you might. 
    # Change these to enabled = TRUE and check out the results.
    hc_navigator(enabled = FALSE) %>% 
    hc_scrollbar(enabled = FALSE)
})
```


Page 2
===========================================

Column
-----------------------------------------------------------------------

### Chart C

```{r}

renderDataTable({
  portfolio <- portfolio_vol_components() %>% 
    as_tibble(preserve_row_names = TRUE) %>% 
    mutate(date = ymd(row.names)) %>% 
    select(-row.names) %>% 
    select(date, everything()) %>% 
    datatable(., fillContainer = TRUE, extensions = 'Buttons', 
            options = list(dom = 'Bfrtip', 
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
})

```

### chart sum

```{r}
renderText({
  summy(1, 2)
})
```


